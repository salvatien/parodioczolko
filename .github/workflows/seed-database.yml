# Database seeding workflow
# This workflow seeds the Cosmos DB database with sample data
# Can only be triggered manually for security and data integrity

name: Seed Database

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to seed'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod
      database_name:
        description: 'Cosmos DB database name'
        required: true
        default: 'ParodioczolkoDb'
        type: string
      container_name:
        description: 'Cosmos DB container name'
        required: true
        default: 'ParodioczolkoSongs'
        type: string
      confirm_action:
        description: 'Type "SEED_DATABASE" to confirm data seeding'
        required: true
        type: string

env:
  DOTNET_VERSION: '8.0.x'
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

jobs:
  validate-input:
    name: 'Validate Input'
    runs-on: ubuntu-latest
    
    steps:
    - name: 'Validate Confirmation'
      run: |
        if [ "${{ github.event.inputs.confirm_action }}" != "SEED_DATABASE" ]; then
          echo "âŒ Invalid confirmation. Please type 'SEED_DATABASE' exactly to confirm."
          exit 1
        fi
        echo "âœ… Confirmation validated. Proceeding with database seeding."
        echo "ðŸ“Š Target Database: ${{ github.event.inputs.database_name }}"
        echo "ðŸ“¦ Target Container: ${{ github.event.inputs.container_name }}"
        echo "ðŸŒ Environment: ${{ github.event.inputs.environment }}"

  get-infrastructure-info:
    name: 'Get Infrastructure Information'
    runs-on: ubuntu-latest
    needs: validate-input
    
    outputs:
      resource_group_name: ${{ steps.get-info.outputs.resource_group_name }}
      function_app_name: ${{ steps.get-info.outputs.function_app_name }}
    
    steps:
    - name: 'Checkout'
      uses: actions/checkout@v4

    - name: 'Azure Login'
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: 'Get Infrastructure Info'
      id: get-info
      run: |
        echo "ðŸ” Looking for infrastructure resources in environment: ${{ env.ENVIRONMENT }}"
        
        # Get resource names from Azure (same method as application workflow)
        RG_NAME=$(az group list --query "[?contains(name, 'rg-parodioczolko-${{ env.ENVIRONMENT }}')].name" -o tsv | head -1)
        if [ -z "$RG_NAME" ]; then
          echo "âŒ Error: Resource group not found for environment ${{ env.ENVIRONMENT }}"
          echo "Available resource groups:"
          az group list --query "[].name" -o table
          exit 1
        fi
        
        FUNC_NAME=$(az functionapp list -g $RG_NAME --query "[?contains(name, 'func-parodioczolko-api-${{ env.ENVIRONMENT }}')].name" -o tsv | head -1)
        if [ -z "$FUNC_NAME" ]; then
          echo "âŒ Error: Function app not found in resource group $RG_NAME"
          echo "Available function apps in $RG_NAME:"
          az functionapp list -g $RG_NAME --query "[].name" -o table
          exit 1
        fi
        
        echo "resource_group_name=$RG_NAME" >> $GITHUB_OUTPUT
        echo "function_app_name=$FUNC_NAME" >> $GITHUB_OUTPUT
        
        echo "âœ… Found resources:"
        echo "- Resource Group: $RG_NAME"
        echo "- Function App: $FUNC_NAME"

  seed-database:
    name: 'Seed Database'
    runs-on: ubuntu-latest
    needs: [validate-input, get-infrastructure-info]
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: 'Setup DotNet ${{ env.DOTNET_VERSION }} Environment'
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Azure Login'
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: 'Get Cosmos DB Connection Info'
      id: cosmos-info
      run: |
        RG_NAME=${{ needs.get-infrastructure-info.outputs.resource_group_name }}
        
        # Find the existing Cosmos DB account (it might be in a different resource group)
        echo "Looking for Cosmos DB accounts..."
        COSMOS_NAME=$(az cosmosdb list --query "[?contains(name, 'kgtcosmosdb') || contains(name, 'cosmos')].name" -o tsv | head -n 1)
        
        if [ -z "$COSMOS_NAME" ]; then
          echo "âŒ No Cosmos DB account found. Please ensure the database exists."
          exit 1
        fi
        
        echo "Found Cosmos DB: $COSMOS_NAME"
        
        # Get the resource group of the Cosmos DB
        COSMOS_RG=$(az cosmosdb list --query "[?name=='$COSMOS_NAME'].resourceGroup" -o tsv)
        
        # Get connection details
        COSMOS_ENDPOINT=$(az cosmosdb show -g $COSMOS_RG -n $COSMOS_NAME --query "documentEndpoint" -o tsv)
        COSMOS_KEY=$(az cosmosdb keys list -g $COSMOS_RG -n $COSMOS_NAME --query "primaryMasterKey" -o tsv)
        
        echo "COSMOS_ENDPOINT=$COSMOS_ENDPOINT" >> $GITHUB_ENV
        echo "COSMOS_KEY=$COSMOS_KEY" >> $GITHUB_ENV
        echo "Database endpoint: $COSMOS_ENDPOINT"

    - name: 'Validate Container Name'
      run: |
        CONTAINER_NAME="${{ github.event.inputs.container_name }}"
        if [[ ! "$CONTAINER_NAME" == *"Parodioczolko"* ]]; then
          echo "âŒ Error: Container name '$CONTAINER_NAME' must contain 'Parodioczolko' for safety."
          echo "This prevents accidentally seeding the wrong container."
          echo "Valid examples: Songs-Parodioczolko, ParodioczolkoSongs, Parodioczolko-Songs"
          exit 1
        fi
        echo "âœ… Container name validation passed: $CONTAINER_NAME"

    - name: 'Build and Run Seeder'
      working-directory: ./backend/ParodioczolkoApi.Seeder
      env:
        COSMOS_DATABASE_NAME: ${{ github.event.inputs.database_name }}
        COSMOS_CONTAINER_NAME: ${{ github.event.inputs.container_name }}
      run: |
        echo "ðŸŒ± Starting database seeding for ${{ env.ENVIRONMENT }} environment..."
        echo "ðŸ“Š Database: ${{ github.event.inputs.database_name }}"
        echo "ðŸ“¦ Container: ${{ github.event.inputs.container_name }}"
        dotnet restore
        dotnet build
        dotnet run production --auto-confirm
        echo "âœ… Database seeding completed successfully!"

    - name: 'Seeding Summary'
      if: success()
      run: |
        echo "## ðŸŒ± Database Seeding Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Details:" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Database**: ${{ github.event.inputs.database_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Container**: ${{ github.event.inputs.container_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Cosmos DB**: Connected successfully" >> $GITHUB_STEP_SUMMARY
        echo "- **Sample Data**: Songs and game data seeded" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŽ® Test the game**: [Play Parodioczolko](https://portal.azure.com)" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“Š Monitor**: Check Application Insights for any issues" >> $GITHUB_STEP_SUMMARY

    - name: 'Seeding Failed'
      if: failure()
      run: |
        echo "## âŒ Database Seeding Failed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Troubleshooting:" >> $GITHUB_STEP_SUMMARY
        echo "- Check if Cosmos DB account exists and is accessible" >> $GITHUB_STEP_SUMMARY
        echo "- Verify Azure permissions for the service principal" >> $GITHUB_STEP_SUMMARY
        echo "- Review the job logs for specific error messages" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Environment: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY