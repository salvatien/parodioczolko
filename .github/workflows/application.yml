# Application deployment workflow
# This workflow builds and deploys the .NET Functions API and Angular frontend
# Runs on application code changes or after infrastructure deployment

name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/application.yml'
  workflow_run:
    workflows: ["Deploy Infrastructure"]
    types:
      - completed

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './backend'
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  get-infrastructure-info:
    name: 'Get Infrastructure Info'
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    
    outputs:
      function_app_name: ${{ steps.get-info.outputs.function_app_name }}
      static_web_app_name: ${{ steps.get-info.outputs.static_web_app_name }}
      resource_group_name: ${{ steps.get-info.outputs.resource_group_name }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: Get Infrastructure Info
      id: get-info
      run: |
        echo "ðŸ” Looking for infrastructure resources in environment: ${{ env.ENVIRONMENT }}"
        
        # Get resource names from Azure (assumes they follow our naming convention)
        RG_NAME=$(az group list --query "[?contains(name, 'rg-parodioczolko-${{ env.ENVIRONMENT }}')].name" -o tsv | head -1)
        if [ -z "$RG_NAME" ]; then
          echo "âŒ Error: Resource group not found for environment ${{ env.ENVIRONMENT }}"
          echo "Available resource groups:"
          az group list --query "[].name" -o table
          exit 1
        fi
        
        FUNC_NAME=$(az functionapp list -g $RG_NAME --query "[?contains(name, 'func-parodioczolko-api-${{ env.ENVIRONMENT }}')].name" -o tsv | head -1)
        if [ -z "$FUNC_NAME" ]; then
          echo "âŒ Error: Function app not found in resource group $RG_NAME"
          echo "Available function apps in $RG_NAME:"
          az functionapp list -g $RG_NAME --query "[].name" -o table
          exit 1
        fi
        
        SWA_NAME=$(az staticwebapp list -g $RG_NAME --query "[?contains(name, 'stapp-parodioczolko-${{ env.ENVIRONMENT }}')].name" -o tsv | head -1)
        if [ -z "$SWA_NAME" ]; then
          echo "âŒ Warning: Static Web App not found in resource group $RG_NAME"
          echo "Available static web apps in $RG_NAME:"
          az staticwebapp list -g $RG_NAME --query "[].name" -o table
        fi
        
        echo "function_app_name=$FUNC_NAME" >> $GITHUB_OUTPUT
        echo "static_web_app_name=$SWA_NAME" >> $GITHUB_OUTPUT
        echo "resource_group_name=$RG_NAME" >> $GITHUB_OUTPUT
        
        echo "âœ… Found resources:"
        echo "- Resource Group: $RG_NAME"
        echo "- Function App: $FUNC_NAME"
        echo "- Static Web App: $SWA_NAME"

  build-and-deploy-api:
    name: 'Build and Deploy API'
    runs-on: ubuntu-latest
    needs: get-infrastructure-info
    
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup DotNet ${{ env.DOTNET_VERSION }} Environment
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Restore dependencies'
      shell: bash
      run: |
        pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/ParodioczolkoApi'
        dotnet restore
        popd

    - name: 'Build project'
      shell: bash
      run: |
        pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/ParodioczolkoApi'
        dotnet build --configuration Release --output ./output
        popd

    - name: 'Run tests'
      shell: bash
      run: |
        pushd './${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}'
        dotnet test ParodioczolkoApi.Tests/ParodioczolkoApi.Tests.csproj --configuration Release --logger trx --results-directory ./TestResults
        popd

    - name: 'Publish test results'
      uses: dorny/test-reporter@v1
      if: (success() || failure()) && github.event_name != 'workflow_run'
      with:
        name: '.NET Tests'
        path: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/TestResults/*.trx'
        reporter: dotnet-trx

    - name: 'Upload test results (workflow_run fallback)'
      if: (success() || failure()) && github.event_name == 'workflow_run'
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/TestResults/*.trx'
        retention-days: 5

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: 'Deploy to Azure Functions'
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ needs.get-infrastructure-info.outputs.function_app_name }}
        package: '${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/ParodioczolkoApi/output'

    - name: 'Test API Health'
      run: |
        sleep 30  # Wait for deployment to complete
        FUNC_URL="https://${{ needs.get-infrastructure-info.outputs.function_app_name }}.azurewebsites.net"
        
        echo "Testing API health at: $FUNC_URL"
        
        # Test if the function app is responding
        if curl -f -s "$FUNC_URL" > /dev/null; then
          echo "âœ… Function App is responding"
        else
          echo "âŒ Function App is not responding"
          exit 1
        fi

  build-and-deploy-frontend:
    name: 'Build and Deploy Frontend'
    runs-on: ubuntu-latest
    needs: [get-infrastructure-info, build-and-deploy-api]
    
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: './frontend/package-lock.json'

    - name: 'Install dependencies'
      working-directory: ./frontend
      run: npm ci

    - name: 'Update API URL in environment'
      working-directory: ./frontend/src/environments
      run: |
        FUNC_NAME="${{ needs.get-infrastructure-info.outputs.function_app_name }}"
        
        # Validate that we have a function app name
        if [ -z "$FUNC_NAME" ] || [ "$FUNC_NAME" = "" ]; then
          echo "âŒ Error: Function App name not found!"
          echo "Available outputs:"
          echo "- function_app_name: ${{ needs.get-infrastructure-info.outputs.function_app_name }}"
          echo "- resource_group_name: ${{ needs.get-infrastructure-info.outputs.resource_group_name }}"
          exit 1
        fi
        
        FUNC_URL="https://${FUNC_NAME}.azurewebsites.net"
        
        echo "ðŸ”§ Updating environment.prod.ts..."
        echo "ðŸ“ Function App Name: $FUNC_NAME"
        echo "ðŸ”— API URL: $FUNC_URL"
        
        # Update the production environment file
        cat > environment.prod.ts << EOF
        export const environment = {
          production: true,
          apiUrl: '$FUNC_URL'
        };
        EOF
        
        echo "âœ… Updated environment.prod.ts with API URL: $FUNC_URL"
        echo "ðŸ“„ Contents of environment.prod.ts:"
        cat environment.prod.ts

    - name: 'Build project'
      working-directory: ./frontend
      run: npm run build -- --configuration production

    - name: 'Run tests'
      working-directory: ./frontend
      run: npm run test -- --watch=false --browsers=ChromeHeadless

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
            "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
            "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
            "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
          }

    - name: 'Deploy to Static Web App'
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: './frontend'
        output_location: 'dist/parodioczolko/browser'

  deployment-summary:
    name: 'Deployment Summary'
    runs-on: ubuntu-latest
    needs: [get-infrastructure-info, build-and-deploy-api, build-and-deploy-frontend]
    if: always()
    
    steps:
    - name: 'Create Deployment Summary'
      run: |
        echo "## ðŸŽ‰ Parodioczolko Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Status:" >> $GITHUB_STEP_SUMMARY
        echo "- **API Deployment**: ${{ needs.build-and-deploy-api.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Deployment**: ${{ needs.build-and-deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Application URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŽ® Game**: [Play Parodioczolko](https://$(echo '${{ needs.get-infrastructure-info.outputs.static_web_app_name }}' | tr -d ' ').azurestaticapps.net)" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ”— API**: [Function App](https://${{ needs.get-infrastructure-info.outputs.function_app_name }}.azurewebsites.net)" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸ“Š Monitoring**: [Application Insights](https://portal.azure.com/#@/resource/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/${{ needs.get-infrastructure-info.outputs.resource_group_name }}/providers/microsoft.insights/components/appi-parodioczolko-${{ env.ENVIRONMENT }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "- **ðŸŒ± Database Seeding**: Run the 'Seed Database' workflow manually to populate sample data" >> $GITHUB_STEP_SUMMARY
        echo "### Environment: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY