# Frontend-only deployment workflow
# This workflow builds and deploys the Angular frontend to Azure Static Web Apps
# Simplified for frontend-only architecture (no backend deployment)

name: Deploy Frontend Only

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod
  push:
    branches:
      - main
      - fe-only
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-only.yml'

env:
  NODE_VERSION: '20.x'
  ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

permissions:
  contents: read
  actions: read

jobs:
  deploy-frontend:
    name: 'Deploy Frontend to Static Web Apps'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'

    - name: Install dependencies
      run: |
        cd frontend
        npm ci

    - name: Build Angular app
      run: |
        cd frontend
        npm run build

    - name: Debug build output
      run: |
        echo "Checking build output..."
        ls -la frontend/dist/
        echo "Contents of parodioczolko directory:"
        ls -la frontend/dist/parodioczolko/ || echo "Directory doesn't exist"
        echo "Looking for index.html:"
        find frontend/dist/ -name "index.html" -type f

    - name: Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: './frontend'
        output_location: 'dist/parodioczolko/browser'
        skip_api_build: true

  deployment-summary:
    name: 'Deployment Summary'
    runs-on: ubuntu-latest
    needs: [deploy-frontend]
    if: always()
    
    steps:
    - name: Deployment Status
      run: |
        echo "## ðŸŽµ Parodioczolko Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
        echo "**Architecture:** Frontend-only (Static JSON data)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.deploy-frontend.result }}" == "success" ]]; then
          echo "âœ… **Frontend Deployment:** SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Application URL:** Available in Azure Static Web Apps portal" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ What's Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- Angular 20 application with 50+ songs" >> $GITHUB_STEP_SUMMARY
          echo "- Static JSON data (no backend API calls)" >> $GITHUB_STEP_SUMMARY
          echo "- Mobile-optimized song guessing game" >> $GITHUB_STEP_SUMMARY
          echo "- Zero ongoing costs (Free tier only)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Frontend Deployment:** FAILED" >> $GITHUB_STEP_SUMMARY
          echo "Check the deployment logs for details." >> $GITHUB_STEP_SUMMARY
        fi